!function(e,t){if("function"==typeof define&&define.amd)define("AudioMotionAnalyzer",["exports"],t);else if("undefined"!=typeof exports)t(exports);else{var i={exports:{}};t(i.exports),e.AudioMotionAnalyzer=i.exports.default}}("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:this,function(e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=e.AudioMotionAnalyzer=void 0;let t=Math.PI,i=2*t,s=t/2,r="dual-combined",a="dual-horizontal",l="single",n="dual-vertical",h="bar-index",o="bar-level",d="gradient",c="click",$="resize",u="sans-serif",f="create",_="fschange",g=$,p="user",m="#fff",y="#888",v="bark",w="linear",x=["#a35","#c66","#e94","#ed0","#9d5","#4d8","#2cb","#0bc","#09c","#36b"],b=[["classic",{colorStops:["red",{color:"yellow",level:.85,pos:.6},{color:"lime",level:.475}]}],["prism",{colorStops:x}],["rainbow",{dir:"h",colorStops:["#817",...x,"#639"]}],["orangered",{bgColor:"#3e2f29",colorStops:["OrangeRed"]}],["steelblue",{bgColor:"#222c35",colorStops:["SteelBlue"]}]],S={alphaBars:!1,ansiBands:!1,barSpace:.1,bgAlpha:.7,channelLayout:l,colorMode:d,fadePeaks:!1,fftSize:8192,fillAlpha:1,frequencyScale:"log",gradient:b[0][0],gravity:3.8,height:void 0,ledBars:!1,linearAmplitude:!1,linearBoost:1,lineWidth:0,loRes:!1,lumiBars:!1,maxDecibels:-25,maxFPS:0,maxFreq:22e3,minDecibels:-85,minFreq:20,mirror:0,mode:0,noteLabels:!1,outlineBars:!1,overlay:!1,peakFadeTime:750,peakHoldTime:500,peakLine:!1,radial:!1,radialInvert:!1,radius:.3,reflexAlpha:.15,reflexBright:1,reflexFit:!0,reflexRatio:0,roundBars:!1,showBgColor:!0,showFPS:!1,showPeaks:!0,showScaleX:!0,showScaleY:!1,smoothing:.5,spinSpeed:0,splitGradient:!1,start:!0,trueLeds:!1,useCanvas:!0,volume:1,weightingFilter:"",width:void 0},B=["ERR_UNKNOWN_GRADIENT","Unknown gradient"],T=["ERR_FREQUENCY_TOO_LOW","Frequency values must be >= 1"],k=["ERR_INVALID_MODE","Invalid mode"],L=["ERR_REFLEX_OUT_OF_RANGE","Reflex ratio must be >= 0 and < 1"],A=["ERR_INVALID_AUDIO_SOURCE","Audio source must be an instance of HTMLMediaElement or AudioNode"],R=["ERR_GRADIENT_INVALID_NAME","Gradient name must be a non-empty string"],C=["ERR_GRADIENT_NOT_AN_OBJECT","Gradient options must be an object"],F=["ERR_GRADIENT_MISSING_COLOR","Gradient colorStops must be a non-empty array"];class q extends Error{constructor(e,t){let[i,s]=e;super(s+(void 0!==t?`: ${t}`:"")),this.name="AudioMotionError",this.code=i}}let E=(e,t)=>console.warn(`${e} is deprecated. Use ${t} instead.`),G=e=>{for(let t in e)return!1;return!0},z=(e,t,i="toLowerCase")=>t[Math.max(0,t.indexOf((""+e)[i]()))],D=(e,t,i,s,r)=>t+(s-t)*(r-e)/(i-e);Array.prototype.findLastIndex||(Array.prototype.findLastIndex=function(e){let t=this.length;for(;t-- >0;)if(e(this[t]))return t;return -1});class I{constructor(e,t={}){this._ready=!1,this._aux={},this._canvasGradients=[],this._destroyed=!1,this._energy={val:0,peak:0,hold:0},this._flg={},this._fps=0,this._gradients={},this._last=0,this._outNodes=[],this._ownContext=!1,this._selectedGrads=[],this._sources=[],e instanceof Element||(G(t)&&!G(e)&&(t=e),e=null),this._ownCanvas=!(t.canvas instanceof HTMLCanvasElement);let i=this._ownCanvas?document.createElement("canvas"):t.canvas;for(let[s,r]of(i.style="max-width: 100%;",this._ctx=i.getContext("2d"),b))this.registerGradient(s,r);this._container=e||!this._ownCanvas&&i.parentElement||document.body,this._defaultWidth=this._container.clientWidth||640,this._defaultHeight=this._container.clientHeight||270;let a;if(t.source&&(a=t.source.context));else if(a=t.audioCtx);else try{a=new(window.AudioContext||window.webkitAudioContext),this._ownContext=!0}catch(l){throw new q(["ERR_AUDIO_CONTEXT_FAIL","Could not create audio context. Web Audio API not supported?"])}if(!a.createGain)throw new q(["ERR_INVALID_AUDIO_CONTEXT","Provided audio context is not valid"]);let n=this._analyzer=[a.createAnalyser(),a.createAnalyser()],h=this._splitter=a.createChannelSplitter(2),o=this._merger=a.createChannelMerger(2);for(let d of(this._input=a.createGain(),this._output=a.createGain(),t.source&&this.connectInput(t.source),[0,1]))h.connect(n[d],d);for(let u of(o.connect(this._output),!1!==t.connectSpeakers&&this.connectOutput(),["_scaleX","_scaleR"]))this[u]=document.createElement("canvas").getContext("2d");this._fsEl=t.fsElement||i;let p=()=>{this._fsTimeout||(this._fsTimeout=window.setTimeout(()=>{this._fsChanging||(this._setCanvas(g),this._fsTimeout=0)},60))};window.ResizeObserver&&(this._observer=new ResizeObserver(p),this._observer.observe(this._container)),this._controller=new AbortController;let m=this._controller.signal;window.addEventListener($,p,{signal:m}),i.addEventListener("fullscreenchange",()=>{this._fsChanging=!0,this._fsTimeout&&window.clearTimeout(this._fsTimeout),this._setCanvas(_),this._fsTimeout=window.setTimeout(()=>{this._fsChanging=!1,this._fsTimeout=0},60)},{signal:m});let y=()=>{"suspended"==a.state&&a.resume(),window.removeEventListener(c,y)};window.addEventListener(c,y),document.addEventListener("visibilitychange",()=>{"hidden"!=document.visibilityState&&(this._frames=0,this._time=performance.now())},{signal:m}),this._setProps(t,!0),this.useCanvas&&this._ownCanvas&&this._container.appendChild(i),this._ready=!0,this._setCanvas(f)}get alphaBars(){return this._alphaBars}set alphaBars(e){this._alphaBars=!!e,this._calcBars()}get ansiBands(){return this._ansiBands}set ansiBands(e){this._ansiBands=!!e,this._calcBars()}get barSpace(){return this._barSpace}set barSpace(e){this._barSpace=+e||0,this._calcBars()}get channelLayout(){return this._chLayout}set channelLayout(e){this._chLayout=z(e,[l,a,n,r]),this._input.disconnect(),this._input.connect(this._chLayout!=l?this._splitter:this._analyzer[0]),this._analyzer[0].disconnect(),this._outNodes.length&&this._analyzer[0].connect(this._chLayout!=l?this._merger:this._output),this._calcBars(),this._makeGrad()}get colorMode(){return this._colorMode}set colorMode(e){this._colorMode=z(e,[d,h,o])}get fadePeaks(){return this._fadePeaks}set fadePeaks(e){this._fadePeaks=!!e}get fftSize(){return this._analyzer[0].fftSize}set fftSize(e){for(let t of[0,1])this._analyzer[t].fftSize=e;let i=this._analyzer[0].frequencyBinCount;this._fftData=[new Float32Array(i),new Float32Array(i)],this._calcBars()}get frequencyScale(){return this._frequencyScale}set frequencyScale(e){this._frequencyScale=z(e,["log",v,"mel",w]),this._calcBars()}get gradient(){return this._selectedGrads[0]}set gradient(e){this._setGradient(e)}get gradientLeft(){return this._selectedGrads[0]}set gradientLeft(e){this._setGradient(e,0)}get gradientRight(){return this._selectedGrads[1]}set gradientRight(e){this._setGradient(e,1)}get gravity(){return this._gravity}set gravity(e){this._gravity=e>0?+e:this._gravity||S.gravity}get height(){return this._height}set height(e){this._height=e,this._setCanvas(p)}get ledBars(){return this._showLeds}set ledBars(e){this._showLeds=!!e,this._calcBars()}get linearAmplitude(){return this._linearAmplitude}set linearAmplitude(e){this._linearAmplitude=!!e}get linearBoost(){return this._linearBoost}set linearBoost(e){this._linearBoost=e>=1?+e:1}get lineWidth(){return this._lineWidth}set lineWidth(e){this._lineWidth=+e||0}get loRes(){return this._loRes}set loRes(e){this._loRes=!!e,this._setCanvas("lores")}get lumiBars(){return this._lumiBars}set lumiBars(e){this._lumiBars=!!e,this._calcBars(),this._makeGrad()}get maxDecibels(){return this._analyzer[0].maxDecibels}set maxDecibels(e){for(let t of[0,1])this._analyzer[t].maxDecibels=e}get maxFPS(){return this._maxFPS}set maxFPS(e){this._maxFPS=e<0?0:+e||0}get maxFreq(){return this._maxFreq}set maxFreq(e){if(e<1)throw new q(T);this._maxFreq=Math.min(e,this.audioCtx.sampleRate/2),this._calcBars()}get minDecibels(){return this._analyzer[0].minDecibels}set minDecibels(e){for(let t of[0,1])this._analyzer[t].minDecibels=e}get minFreq(){return this._minFreq}set minFreq(e){if(e<1)throw new q(T);this._minFreq=+e,this._calcBars()}get mirror(){return this._mirror}set mirror(e){this._mirror=0|Math.sign(e),this._calcBars(),this._makeGrad()}get mode(){return this._mode}set mode(e){let t=0|e;if(t>=0&&t<=10&&9!=t)this._mode=t,this._calcBars(),this._makeGrad();else throw new q(k,e)}get noteLabels(){return this._noteLabels}set noteLabels(e){this._noteLabels=!!e,this._createScales()}get outlineBars(){return this._outlineBars}set outlineBars(e){this._outlineBars=!!e,this._calcBars()}get peakFadeTime(){return this._peakFadeTime}set peakFadeTime(e){this._peakFadeTime=e>=0?+e:this._peakFadeTime||S.peakFadeTime}get peakHoldTime(){return this._peakHoldTime}set peakHoldTime(e){this._peakHoldTime=+e||0}get peakLine(){return this._peakLine}set peakLine(e){this._peakLine=!!e}get radial(){return this._radial}set radial(e){this._radial=!!e,this._calcBars(),this._makeGrad()}get radialInvert(){return this._radialInvert}set radialInvert(e){this._radialInvert=!!e,this._calcBars(),this._makeGrad()}get radius(){return this._radius}set radius(e){this._radius=+e||0,this._calcBars(),this._makeGrad()}get reflexRatio(){return this._reflexRatio}set reflexRatio(e){if((e=+e||0)<0||e>=1)throw new q(L);this._reflexRatio=e,this._calcBars(),this._makeGrad()}get roundBars(){return this._roundBars}set roundBars(e){this._roundBars=!!e,this._calcBars()}get smoothing(){return this._analyzer[0].smoothingTimeConstant}set smoothing(e){for(let t of[0,1])this._analyzer[t].smoothingTimeConstant=e}get spinSpeed(){return this._spinSpeed}set spinSpeed(e){e=+e||0,(void 0===this._spinSpeed||0==e)&&(this._spinAngle=-s),this._spinSpeed=e}get splitGradient(){return this._splitGradient}set splitGradient(e){this._splitGradient=!!e,this._makeGrad()}get stereo(){return E("stereo","channelLayout"),this._chLayout!=l}set stereo(e){E("stereo","channelLayout"),this.channelLayout=e?n:l}get trueLeds(){return this._trueLeds}set trueLeds(e){this._trueLeds=!!e}get volume(){return this._output.gain.value}set volume(e){this._output.gain.value=e}get weightingFilter(){return this._weightingFilter}set weightingFilter(e){this._weightingFilter=z(e,["","A","B","C","D","468"],"toUpperCase")}get width(){return this._width}set width(e){this._width=e,this._setCanvas(p)}get audioCtx(){return this._input.context}get canvas(){return this._ctx.canvas}get canvasCtx(){return this._ctx}get connectedSources(){return this._sources}get connectedTo(){return this._outNodes}get fps(){return this._fps}get fsHeight(){return this._fsHeight}get fsWidth(){return this._fsWidth}get isAlphaBars(){return this._flg.isAlpha}get isBandsMode(){return this._flg.isBands}get isDestroyed(){return this._destroyed}get isFullscreen(){return this._fsEl&&(document.fullscreenElement||document.webkitFullscreenElement)===this._fsEl}get isLedBars(){return this._flg.isLeds}get isLumiBars(){return this._flg.isLumi}get isOctaveBands(){return this._flg.isOctaves}get isOn(){return!!this._runId}get isOutlineBars(){return this._flg.isOutline}get pixelRatio(){return this._pixelRatio}get isRoundBars(){return this._flg.isRound}static get version(){return"4.5.0"}connectInput(e){let t=e instanceof HTMLMediaElement;if(!(t||e.connect))throw new q(A);let i=t?this.audioCtx.createMediaElementSource(e):e;return this._sources.includes(i)||(i.connect(this._input),this._sources.push(i)),i}connectOutput(e=this.audioCtx.destination){if(!this._outNodes.includes(e)&&(this._output.connect(e),this._outNodes.push(e),1==this._outNodes.length))for(let t of[0,1])this._analyzer[t].connect(this._chLayout!=l||t?this._merger:this._output,0,t)}destroy(){if(!this._ready)return;let{audioCtx:e,canvas:t,_controller:i,_input:s,_merger:r,_observer:a,_ownCanvas:l,_ownContext:n,_splitter:h}=this;this._destroyed=!0,this._ready=!1,this.stop(),i.abort(),a&&a.disconnect(),this.onCanvasResize=null,this.onCanvasDraw=null,this._fsEl=null,this.disconnectInput(),this.disconnectOutput(),s.disconnect(),h.disconnect(),r.disconnect(),n&&e.close(),l&&t.remove(),this._calcBars()}disconnectInput(e,t){for(let i of(e?Array.isArray(e)||(e=[e]):e=Array.from(this._sources),e)){let s=this._sources.indexOf(i);if(t&&i.mediaStream)for(let r of i.mediaStream.getAudioTracks())r.stop();s>=0&&(i.disconnect(this._input),this._sources.splice(s,1))}}disconnectOutput(e){if((!e||this._outNodes.includes(e))&&(this._output.disconnect(e),this._outNodes=e?this._outNodes.filter(t=>t!==e):[],0==this._outNodes.length))for(let t of[0,1])this._analyzer[t].disconnect()}getBars(){return Array.from(this._bars,({posX:e,freq:t,freqLo:i,freqHi:s,hold:r,peak:a,value:l})=>({posX:e,freq:t,freqLo:i,freqHi:s,hold:r,peak:a,value:l}))}getEnergy(e,t){if(void 0===e)return this._energy.val;if(e!=+e){if("peak"==e)return this._energy.peak;let i={bass:[20,250],lowMid:[250,500],mid:[500,2e3],highMid:[2e3,4e3],treble:[4e3,16e3]};if(!i[e])return null;[e,t]=i[e]}let s=this._freqToBin(e),r=t?this._freqToBin(t):s,a=this._chLayout==l?1:2,n=0;for(let h=0;h<a;h++)for(let o=s;o<=r;o++)n+=this._normalizedB(this._fftData[h][o]);return n/(r-s+1)/a}getOptions(e){Array.isArray(e)||(e=[e]);let t={};for(let i of Object.keys(S))e.includes(i)||("gradient"==i&&this.gradientLeft!=this.gradientRight?(t.gradientLeft=this.gradientLeft,t.gradientRight=this.gradientRight):"start"==i||(t[i]=this[i]));return t}registerGradient(e,t){if("string"!=typeof e||0==e.trim().length)throw new q(R);if("object"!=typeof t)throw new q(C);let{colorStops:i}=t;if(!Array.isArray(i)||!i.length)throw new q(F);let s=i.length,r=e=>+e!=e||e<0||e>1;i.forEach((e,t)=>{let a=t/Math.max(1,s-1);"object"!=typeof e?i[t]={pos:a,color:e}:r(e.pos)&&(e.pos=a),r(e.level)&&(i[t].level=1-t/s)}),i.sort((e,t)=>e.level<t.level?1:e.level>t.level?-1:0),i[0].level=1,this._gradients[e]={bgColor:t.bgColor||"#111",dir:t.dir,colorStops:i},this._selectedGrads.includes(e)&&this._makeGrad()}setCanvasSize(e,t){this._width=e,this._height=t,this._setCanvas(p)}setFreqRange(e,t){if(e<1||t<1)throw new q(T);this._minFreq=Math.min(e,t),this.maxFreq=Math.max(e,t)}setLedParams(e){let t,i,s;e&&(t=0|e.maxLeds,i=+e.spaceV,s=+e.spaceH),this._ledParams=t>0&&i>0&&s>=0?[t,i,s]:void 0,this._calcBars()}setOptions(e){this._setProps(e)}setSensitivity(e,t){for(let i of[0,1])this._analyzer[i].minDecibels=Math.min(e,t),this._analyzer[i].maxDecibels=Math.max(e,t)}start(){this.toggleAnalyzer(!0)}stop(){this.toggleAnalyzer(!1)}toggleAnalyzer(e){let t=this.isOn;return void 0===e&&(e=!t),t&&!e?(cancelAnimationFrame(this._runId),this._runId=0):t||!e||this._destroyed||(this._frames=0,this._time=performance.now(),this._runId=requestAnimationFrame(e=>this._draw(e))),this.isOn}toggleFullscreen(){if(this.isFullscreen)document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen&&document.webkitExitFullscreen();else{let e=this._fsEl;if(!e)return;e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen()}}_binToFreq(e){return e*this.audioCtx.sampleRate/this.fftSize||1}_calcBars(){let e=this._bars=[];if(!this._ready){this._flg={isAlpha:!1,isBands:!1,isLeds:!1,isLumi:!1,isOctaves:!1,isOutline:!1,isRound:!1,noLedGap:!1};return}let{_ansiBands:t,_barSpace:i,canvas:s,_chLayout:r,_maxFreq:l,_minFreq:h,_mirror:o,_mode:d,_radial:c,_radialInvert:$,_reflexRatio:u}=this,f=s.width>>1,_=s.height>>1,g=r==n&&!c,p=r==a,m=d%10!=0,y=m&&"log"==this._frequencyScale,x=this._showLeds&&m&&!c,b=this._lumiBars&&m&&!c,S=this._alphaBars&&!b&&10!=d,B=this._outlineBars&&m&&!b&&!x,T=this._roundBars&&m&&!b&&!x,k=r!=n||u>0&&!b,L=s.height-(g&&!x?.5:0)>>g,A=L*(b||c?1:1-u)|0,R=s.width-f*(p||0!=o),C=g?s.height-2*L:0,F=f*(-1==o&&!p&&!c),q=.375*Math.min(s.width,s.height)*(r==n?1:this._radius)|0,E=Math.min(f,_);$&&r!=n&&([q,E]=[E,q]);let G=t=>e.push({...t,peak:[0,0],hold:[0],alpha:[0],value:[0]}),z=e=>{let t=this._freqToBin(e,"floor"),i=this._binToFreq(t),s=this._binToFreq(t+1);return[t,Math.log2(e/i)/Math.log2(s/i)]},D,I,O;if(y){let P=(e,t,i)=>+e.toPrecision(i?Math.max(t,1+Math.log10(e)|0):t),N=e=>{let t=[1,1.12,1.25,1.4,1.6,1.8,2,2.24,2.5,2.8,3.15,3.55,4,4.5,5,5.6,6.3,7.1,8,9,10],i=0|Math.log10(e),s=e/10**i,r=1;for(;r<t.length&&s>t[r];)r++;return s-t[r-1]<t[r]-s&&r--,(t[r]*10**(i+5)|0)/1e5},H=[0,24,12,8,6,4,3,2,1][d],W=t?10**(3/(10*H)):2**(1/H),M=W**.5,X=t?7.94328235/(H%2?1:M):8.17579892;do{let U=X,V=P(U/M,4,!0),j=P(U*M,4,!0),[Y,J]=z(V),[K,Q]=z(j);(U=t?H<4?N(U):P(U,U.toString()[0]<5?3:2):P(U,4,!0))>=h&&G({posX:0,freq:U,freqLo:V,freqHi:j,binLo:Y,binHi:K,ratioLo:J,ratioHi:Q}),X*=W}while(X<=l);D=R/e.length,e.forEach((e,t)=>e.posX=F+t*D);let Z=e[0],ee=e[e.length-1];I=this._freqScaling(Z.freqLo),O=R/(this._freqScaling(ee.freqHi)-I),Z.freqLo<h&&(Z.freqLo=h,[Z.binLo,Z.ratioLo]=z(h)),ee.freqHi>l&&(ee.freqHi=l,[ee.binHi,ee.ratioHi]=z(l))}else if(m){let et=10*[0,24,12,8,6,4,3,2,1][d],ei=e=>{switch(this._frequencyScale){case v:return 1960/(26.81/(e+.53)-1);case"mel":return 700*(2**e-1);case w:return e}};D=R/et,I=this._freqScaling(h),O=R/(this._freqScaling(l)-I);for(let es=0,er=0;es<et;es++,er+=D){let ea=ei(I+er/O),el=ei(I+(er+D/2)/O),en=ei(I+(er+D)/O),[eh,eo]=z(ea),[ed,e8]=z(en);G({posX:F+er,freq:el,freqLo:ea,freqHi:en,binLo:eh,binHi:ed,ratioLo:eo,ratioHi:e8})}}else{D=1,I=this._freqScaling(h),O=R/(this._freqScaling(l)-I);let ec=this._freqToBin(h,"floor"),e$=this._freqToBin(l),eu=-999;for(let ef=ec;ef<=e$;ef++){let e_=this._binToFreq(ef),eg=F+Math.round(O*(this._freqScaling(e_)-I));if(eg>eu)G({posX:eg,freq:e_,freqLo:e_,freqHi:e_,binLo:ef,binHi:ef,ratioLo:0,ratioHi:0}),eu=eg;else if(e.length){let ep=e[e.length-1];ep.binHi=ef,ep.freqHi=e_,ep.freq=(ep.freqLo*e_)**.5}}}let em=0,e0=0;if(x){let ey=this._pixelRatio/(window.devicePixelRatio>1&&window.screen.height<=540?2:1),ev=this._ledParams,[ew,ex,eb]=ev||[[],[128,3,.45],[128,4,.225],[96,6,.225],[80,6,.225],[80,6,.125],[64,6,.125],[48,8,.125],[24,16,.125]][d],eS,e1=A;if(ev){let eB=2*ey,e3;eS=ew+1;do e0=(e3=e1/--eS/(1+ex))*ex;while((e3<eB||e0<eB)&&eS>1)}else e0=Math.min(ex*ey,Math.max(2,e1/(540/ex)+.1|0));k&&(e1+=e0),ev||(eS=Math.min(ew,e1/(2*e0)|0)),em=eb>=1?eb:D*eb,this._leds=[eS,em,e0,e1/eS-e0]}let eT=Math.min(D-1,i*(i>0&&i<1?D:1));m&&(D-=Math.max(x?em:0,eT)),e.forEach((t,s)=>{let r=t.posX,a=D;m&&(0!=i||x?r+=Math.max(x?em:0,eT)/2:(r|=0,a|=0,s>0&&r>e[s-1].posX+e[s-1].width&&(r--,a++)),t.posX=r),t.barCenter=r+(1==D?0:a/2),t.width=a});let ek=[];for(let eL of[0,1]){let eA=r==n?(L+C)*eL:0,eR=eA+L,e4=eA+A-(!x||k?0:e0);ek.push({channelTop:eA,channelBottom:eR,analyzerBottom:e4})}this._aux={analyzerHeight:A,analyzerWidth:R,centerX:f,centerY:_,channelCoords:ek,channelHeight:L,channelGap:C,initialX:F,innerRadius:q,outerRadius:E,scaleMin:I,unitWidth:O},this._flg={isAlpha:S,isBands:m,isLeds:x,isLumi:b,isOctaves:y,isOutline:B,isRound:T,noLedGap:k},this._createScales()}_createScales(){if(!this._ready)return;let{analyzerWidth:e,initialX:t,innerRadius:r,scaleMin:l,unitWidth:h}=this._aux,{canvas:o,_frequencyScale:d,_mirror:c,_noteLabels:$,_radial:f,_scaleX:_,_scaleR:g}=this,p=_.canvas,y=g.canvas,v=[],x=this._chLayout==a,b=this._chLayout==n,S=Math.min(o.width,o.height),B=["C",,"D",,"E","F",,"G",,"A",,"B"],T=S/34|0,k=p.height>>1,L=T>>1,A=k*($?.7:1.5),R=L*($?1:2),C=2**(1/12);if(!$&&(this._ansiBands||"log"!=d))v.push(16,31.5,63,125,250,500,1e3,2e3,4e3),d==w?v.push(6e3,8e3,1e4,12e3,14e3,16e3,18e3,2e4,22e3):v.push(8e3,16e3);else{let F=8.17579892;for(let q=-1;q<11;q++)for(let E=0;E<12;E++){if(F>=this._minFreq&&F<=this._maxFreq){let G=B[E],z="C"==G;(G&&$&&!c&&!x||z)&&v.push($?[F,G+(z?q:"")]:F)}F*=C}}y.width=y.height=Math.max(.15*S,(r<<1)+b*T);let D=y.width>>1,I=D-.7*T,O=(e,t)=>{let r=i*(e/o.width),a=r-s;g.save(),g.translate(D+I*Math.cos(a),D+I*Math.sin(a)),g.rotate(r),g.fillText(t,0,0),g.restore()};p.width|=0,_.fillStyle=g.strokeStyle="#000c",_.fillRect(0,0,p.width,p.height),g.arc(D,D,D-T/2,0,i),g.lineWidth=T,g.stroke(),_.fillStyle=g.fillStyle=m,_.font=`${k}px ${u}`,g.font=`${L}px ${u}`,_.textAlign=g.textAlign="center";let P=-A/4,N=-R;for(let H of v){let[W,M]=Array.isArray(H)?H:[H,H<1e3?0|H:`${(H/100|0)/10}k`],X=h*(this._freqScaling(W)-l),U=.75*p.height,V="C"==M[0],j=k*(!$||c||x?3:V?1.2:.6);if(_.fillStyle=g.fillStyle=!V||c||x?m:"#4f4",$){let Y="log"==d,J=d==w,K=["C"];if((Y||W>2e3||!J&&W>250||(!f||b)&&(!J&&W>125||W>1e3))&&K.push("G"),(Y||W>4e3||!J&&W>500||(!f||b)&&(!J&&W>250||W>2e3))&&K.push("E"),(J&&W>4e3||(!f||b)&&(Y||W>2e3||!J&&W>500))&&K.push("D","F","A","B"),!K.includes(M[0]))continue}X>=P+A/2&&X<=e&&(_.fillText(M,x&&-1==c?e-X:t+X,U,j),(x||c&&(X>A||1==c))&&_.fillText(M,x&&1!=c?e+X:(t||o.width)-X,U,j),P=X+Math.min(j,_.measureText(M).width)/2),X>=N+R&&X<e-R&&(O(x&&1==c?e-X:X,M),(x||c&&(X>R||1==c))&&O(x&&-1!=c?e+X:-X,M),N=X)}}_draw(e){this._runId=requestAnimationFrame(e=>this._draw(e));let c=e-this._time,$=e-this._last,f=this._maxFPS?975/this._maxFPS:0;if($<f)return;this._last=e-(f?$%f:0),this._frames++,c>=1e3&&(this._fps=this._frames/c*1e3,this._frames=0,this._time=e);let{isAlpha:_,isBands:g,isLeds:p,isLumi:m,isOctaves:v,isOutline:w,isRound:x,noLedGap:b}=this._flg,{analyzerHeight:S,centerX:B,centerY:T,channelCoords:k,channelHeight:L,channelGap:A,initialX:R,innerRadius:C,outerRadius:F}=this._aux,{_bars:q,canvas:E,_canvasGradients:G,_chLayout:z,_colorMode:I,_ctx:O,_energy:P,_fadePeaks:N,fillAlpha:H,_fps:W,_linearAmplitude:M,_lineWidth:X,maxDecibels:U,minDecibels:V,_mirror:j,_mode:Y,overlay:J,_radial:K,showBgColor:Q,showPeaks:Z,useCanvas:ee,_weightingFilter:et}=this,ei=this._scaleX.canvas,es=this._scaleR.canvas,er=W*this._peakFadeTime/1e3,ea=W**2,el=1e3*this._gravity,en=W*this._peakHoldTime/1e3,eh=z==r,eo=z==a,ed=z==n,e8=p&&this._trueLeds&&I==d,ec=K?E.width:this._aux.analyzerWidth,e$=R+ec,eu=Z&&this._peakLine&&10==Y,ef=K?F-C:S,e_=ef/this._pixelRatio,[eg,ep,em,e0]=this._leds||[];P.val>0&&W>0&&(this._spinAngle+=this._spinSpeed*i/60/W);let ey=e=>{if(this._reflexRatio>0&&!m&&!K){let t,i;this.reflexFit||ed?(t=ed&&0==e?L+A:0,i=L-S):(t=E.height-2*S,i=S),O.save(),O.globalAlpha=this.reflexAlpha,1!=this.reflexBright&&(O.filter=`brightness(${this.reflexBright})`),O.setTransform(1,0,0,-1,0,E.height),O.drawImage(E,0,k[e].channelTop,E.width,S,0,t,E.width,i),O.restore()}},ev=e=>{let t=e**2,i=e=>20*Math.log10(e);switch(et){case"A":return 2+i(148693636*t**2/((t+424.36)*Math.sqrt((t+11599.29)*(t+544496.41))*(t+148693636)));case"B":return .17+i(148693636*t*e/((t+424.36)*Math.sqrt(t+25122.25)*(t+148693636)));case"C":return .06+i(148693636*t/((t+424.36)*(t+148693636)));case"D":return i(e/68966888496476e-18*Math.sqrt(((1037918.48-t)**2+1080768.16*t)/((9837328-t)**2+11723776*t)/((t+79919.29)*(t+1345600))));case"468":return 18.2+i(1246332637532143e-19*e/Math.hypot(-.000000000000000000000004737338981378384*e**6+2043828333606125e-30*e**4-1363894795463638e-22*t+1,1306612257412824e-34*e**5-2118150887518656e-26*e**3+5559488023498642e-19*e))}return 0},ew=(e,t,i)=>{O.beginPath(),O.moveTo(e,t),O.lineTo(e,i),O.stroke()},ex=e=>{if(e&&X){let t=O.globalAlpha;O.globalAlpha=1,O.stroke(),O.globalAlpha=t}},eb=e=>Math.max(0,(e*eg|0)*(e0+em)-em);J&&O.clearRect(0,0,E.width,E.height);let eS=0,e1=q.length,eB=z==l?1:2;for(let e3=0;e3<eB;e3++){let{channelTop:eT,channelBottom:ek,analyzerBottom:eL}=k[e3],eA=this._gradients[this._selectedGrads[e3]],eR=eA.colorStops,e4=eR.length,e2=Q&&(!p||J)?eA.bgColor:"#000",eC=ed&&K&&e3?-1:1,e6=!e3&&-1==j||e3&&1==j,eF=!eo||e3&&1!=j?0:ec>>(e3||!e6),eq=eo&&e6?-1:1,eE=()=>{let e=ei.height,t=e>>1,i=M?100:U,s=M?0:V,r=M?20:5,a=S/(i-s),l=-1!=j&&(!eo||0==e3||1==j),n=1!=j&&(!eo||e3!=j);O.save(),O.fillStyle=y,O.font=`${t}px ${u}`,O.textAlign="right",O.lineWidth=1;for(let h=i;h>s;h-=r){let o=eT+(i-h)*a,d=h%2==0|0;if(d){let c=o+t*(o==eT?.8:.35);l&&O.fillText(h,.85*e,c),n&&O.fillText(h,(eo?ec:E.width)-.1*e,c),O.strokeStyle=y,O.setLineDash([2,4]),O.lineDashOffset=0}else O.strokeStyle="#555",O.setLineDash([2,8]),O.lineDashOffset=1;O.beginPath(),O.moveTo(R+e*d*l,~~o+.5),O.lineTo(e$-e*d*n,~~o+.5),O.stroke()}O.restore()},eG=(e,t)=>{let i=eN[e]+(e<eN.length-1?(eN[e+1]-eN[e])*t:0);return isNaN(i)?-1/0:i},ez=(e,t=eq)=>t*i*((e+eF)/E.width)+this._spinAngle,eD=(e,t,i)=>{let s=C+t*eC,r=ez(e,i);return[B+s*Math.cos(r),T+s*Math.sin(r)]},e7=(e,t,i,s,r)=>{for(let a of(O.beginPath(),j&&!eo?[1,-1]:[eq])){let[l,n]=x?[ez(e,a),ez(e+i,a)]:[];O.moveTo(...eD(e,t,a)),O.lineTo(...eD(e,t+s,a)),x?O.arc(B,T,C+(t+s)*eC,l,n,1!=a):O.lineTo(...eD(e+i,t+s,a)),O.lineTo(...eD(e+i,t,a)),x&&!r&&O.arc(B,T,C+t*eC,n,l,1==a)}ex(r),O.fill()},eI=(e=0,t=0)=>{let i;if((I!=d||e8)&&10!=Y){let s=I==h?t%e4:eR.findLastIndex(t=>p?eb(e)<=eb(t.level):e<=t.level);i=eR[s].color}else i=G[e3];O.fillStyle=O.strokeStyle=i};if(ee){if(eo&&!K){let eO=ec*(e3+e6),e5=e6?-1:1;O.setTransform(e5,0,0,1,eO,0)}if((!J||Q)&&(J&&(O.globalAlpha=this.bgAlpha),O.fillStyle=e2,0!=e3&&(K||eh)||O.fillRect(R,eT-A,ec,(J&&1==this.reflexAlpha?S:L)+A),O.globalAlpha=1),!this.showScaleY||m||K||0!=e3&&eh||eE(),p?(O.setLineDash([e0,em]),O.lineWidth=q[0].width):O.lineWidth=w?Math.min(X,q[0].width/2):X,O.save(),!K){let eP=new Path2D;eP.rect(0,eT,E.width,S),O.clip(eP)}}let eN=this._fftData[e3];this._analyzer[e3].getFloatFrequencyData(eN),et&&(eN=eN.map((e,t)=>e+ev(this._binToFreq(t)))),O.beginPath();let eH=[];for(let eW=0;eW<e1;eW++){let eM=q[eW],{posX:eX,barCenter:e9,width:eU,freq:eV,binLo:ej,binHi:eY,ratioLo:eJ,ratioHi:eK}=eM,eQ=Math.max(eG(ej,eJ),eG(eY,eK));for(let eZ=ej+1;eZ<eY;eZ++)eN[eZ]>eQ&&(eQ=eN[eZ]);if(eQ=this._normalizedB(eQ),eM.value[e3]=eQ,eS+=eQ,eM.peak[e3]>0&&eM.alpha[e3]>0&&(eM.hold[e3]--,eM.hold[e3]<0)){if(N&&!eu){let te=!_||w&&X>0?1:_?eM.peak[e3]:H;eM.alpha[e3]=te*(1+eM.hold[e3]/er)}else eM.peak[e3]+=eM.hold[e3]*el/ea/e_;eM.alpha[e3]<=0&&(eM.peak[e3]=0)}if(eQ>=eM.peak[e3]&&(eM.peak[e3]=eQ,eM.hold[e3]=en,eM.alpha[e3]=!_||w&&X>0?1:_?eQ:H),!ee)continue;O.globalAlpha=m||_?eQ:w?H:1,eI(eQ,eW);let tt=m?ef:p?eb(eQ):eQ*ef|0;if(10==Y){let ti=eW?0:(this._normalizedB(eN[q[1].binLo])*ef+tt)/2;if(K){if(0==eW&&(eo&&O.moveTo(...eD(0,0)),O.lineTo(...eD(0,eX<0?ti:tt))),eX>=0){let ts=[eX,tt];O.lineTo(...eD(...ts)),eH.push(ts)}}else{if(0==eW){if(-1!=j||eo){let tr=ej?this._normalizedB(eN[ej-1])*ef:tt;O.moveTo(R-X,eL-tr)}else O.moveTo(R,eL-(eX<R?ti:tt))}(eo||-1!=j||eX>=R)&&O.lineTo(eX,eL-tt)}}else if(p){if(Q&&!J&&(0==e3||!eh)){let ta=O.globalAlpha;O.strokeStyle="#7f7f7f22",O.globalAlpha=1,ew(e9,eT,eL),O.strokeStyle=O.fillStyle,O.globalAlpha=ta}if(e8){let tl=m?0:eR.findLastIndex(e=>eb(eQ)<=eb(e.level)),tn=eL;for(let th=e4-1;th>=tl;th--){O.strokeStyle=eR[th].color;let to=eL-(th==tl?tt:eb(eR[th].level));ew(e9,tn,to),tn=to-em}}else ew(e9,eL,eL-tt)}else if(eX>=R){if(K)e7(eX,0,eU,tt,w);else if(x){let td=eU/2,t8=eL+td;O.beginPath(),O.moveTo(eX,t8),O.lineTo(eX,t8-tt),O.arc(e9,t8-tt,td,t,i),O.lineTo(eX+eU,t8),ex(w),O.fill()}else{let tc=w?O.lineWidth:0;O.beginPath(),O.rect(eX,eL+tc,eU,-tt-tc),ex(w),O.fill()}}let t$=eM.peak[e3],tu=eM.alpha[e3];if(t$>0&&tu>0&&Z&&!eu&&!m&&eX>=R&&eX<e$){if(N?O.globalAlpha=tu:w&&X>0?O.globalAlpha=1:_&&(O.globalAlpha=t$),(I==o||e8)&&eI(t$),p){let tf=eb(t$);tf>=em&&O.fillRect(eX,eL-tf,eU,e0)}else if(K){if(10!=Y){let t_=t$*ef;e7(eX,t_,eU,!this._radialInvert||ed||t_+C>=2?-2:2)}}else O.fillRect(eX,eL-t$*ef,eU,2)}}if(ee){if(O.globalAlpha=1,10==Y){if(eI(),K&&!eo){if(j){let tg;for(;tg=eH.pop();)O.lineTo(...eD(...tg,-1))}O.closePath()}if(X>0&&O.stroke(),H>0){if(K){let tp=eo?ez(ec>>1):0,tm=eo?ez(ec):i;O.moveTo(...eD(eo?ec>>1:0,0)),O.arc(B,T,C,tp,tm,!eo||!e6)}else O.lineTo(e$,eL),O.lineTo(R,eL);O.globalAlpha=H,O.fill(),O.globalAlpha=1}if((eu||K&&Z)&&(eH=[],O.beginPath(),q.forEach((e,t)=>{let i=e.posX,s=e.peak[e3],r=t?"lineTo":"moveTo";if(K&&i<0){let a=q[t+1];s=D(i,s,a.posX,a.peak[e3],0),i=0}s*=ef,eu?(O[r](...K?eD(i,s):[i,eL-s]),K&&j&&!eo&&eH.push([i,s])):s>0&&e7(i,s,1,-2)}),eu)){let t0;for(;t0=eH.pop();)O.lineTo(...eD(...t0,-1));O.lineWidth=1,O.stroke()}}O.restore(),eo&&!K&&O.setTransform(1,0,0,1,0,0),(eo||eh)&&!e3||ey(e3)}}if((e=>{P.val=e,P.peak>0&&(P.hold--,P.hold<0&&(P.peak+=P.hold*el/ea/E.height*this._pixelRatio)),e>=P.peak&&(P.peak=e,P.hold=en)})(eS/(e1<<eB-1)),ee&&(!j||K||eo||(O.setTransform(-1,0,0,1,E.width-R,0),O.drawImage(E,R,0,B,E.height,0,0,B,E.height),O.setTransform(1,0,0,1,0,0)),O.setLineDash([]),(()=>{this.showScaleX&&(K?(O.save(),O.translate(B,T),this._spinSpeed&&O.rotate(this._spinAngle+s),O.drawImage(es,-es.width>>1,-es.width>>1),O.restore()):O.drawImage(ei,0,E.height-ei.height))})()),this.showFPS){let ty=ei.height;O.font=`bold ${ty}px ${u}`,O.fillStyle="#0f0",O.textAlign="right",O.fillText(Math.round(W),E.width-ty,2*ty)}this.onCanvasDraw&&(O.save(),O.fillStyle=O.strokeStyle=G[0],this.onCanvasDraw(this,{timestamp:e,canvasGradients:G}),O.restore())}_freqScaling(e){switch(this._frequencyScale){case"log":return Math.log2(e);case v:return 26.81*e/(1960+e)-.53;case"mel":return Math.log2(1+e/700);case w:return e}}_freqToBin(e,t="round"){let i=this._analyzer[0].frequencyBinCount-1,s=Math[t](e*this.fftSize/this.audioCtx.sampleRate);return s<i?s:i}_makeGrad(){if(!this._ready)return;let{canvas:e,_ctx:t,_radial:i,_reflexRatio:s}=this,{analyzerWidth:r,centerX:a,centerY:l,initialX:h,innerRadius:o,outerRadius:d}=this._aux,{isLumi:c}=this._flg,$=this._chLayout==n,u=1-s,f=c?e.height:e.height*(1-!$*s)|0;for(let _ of[0,1]){let g=this._gradients[this._selectedGrads[_]],p=g.colorStops,m="h"==g.dir,y;if(y=i?t.createRadialGradient(a,l,d,a,l,o-(d-o)*$):t.createLinearGradient(...m?[h,0,h+r,0]:[0,0,0,f]),p){let v=$&&!this._splitGradient&&(!m||i);for(let w=0;w<1+v;w++){let x=p.length-1;p.forEach((e,t)=>{let r=e.pos;if(v&&(r/=2),!$||c||i||m||(r*=u,v||!(r>.5*u)||(r+=.5*s)),1==w){if(i||c){let a=x-t;r=1-(e=p[a]).pos/2}else 0==t&&r>0&&y.addColorStop(.5,e.color),r+=.5}y.addColorStop(r,e.color),$&&t==x&&r<.5&&y.addColorStop(.5,e.color)})}}this._canvasGradients[_]=y}}_normalizedB(e){var t,i,s,r,a,l;let n=this._linearAmplitude,h=n?1/this._linearBoost:1,o=this.maxDecibels,d=this.minDecibels;return n&&(o=10**(o/20),d=10**(d/20),e=(10**(e/20))**h),(r=(e-d)/(o-d)**h)<=0?0:r>=1?1:r}_setCanvas(e){if(!this._ready)return;let{canvas:t,_ctx:i}=this,s=this._scaleX.canvas,r=window.devicePixelRatio/(this._loRes+1),a=window.screen.width*r,l=window.screen.height*r;90==Math.abs(window.orientation)&&a<l&&([a,l]=[l,a]);let n=this.isFullscreen,h=n&&this._fsEl==t,o=h?a:(this._width||this._container.clientWidth||this._defaultWidth)*r|0,d=h?l:(this._height||this._container.clientHeight||this._defaultHeight)*r|0;this._pixelRatio=r,this._fsWidth=a,this._fsHeight=l,(e==f||t.width!=o||t.height!=d)&&(t.width=o,t.height=d,this.overlay||(i.fillStyle="#000",i.fillRect(0,0,o,d)),i.lineJoin="bevel",s.width=o,s.height=Math.max(20*r,Math.min(o,d)/32|0),this._calcBars(),this._makeGrad(),void 0!==this._fsStatus&&this._fsStatus!==n&&(e=_),this._fsStatus=n,this.onCanvasResize&&this.onCanvasResize(e,this))}_setGradient(e,t){if(!this._gradients.hasOwnProperty(e))throw new q(B,e);[0,1].includes(t)||(this._selectedGrads[1]=e,t=0),this._selectedGrads[t]=e,this._makeGrad()}_setProps(e,t){let i=["onCanvasDraw","onCanvasResize"],s=Object.keys(S).filter(e=>"start"!=e).concat(i,["gradientLeft","gradientRight","stereo"]);for(let r of((t||void 0===e)&&(e={...S,...e}),Object.keys(e)))i.includes(r)&&"function"!=typeof e[r]?this[r]=void 0:s.includes(r)&&(this[r]=e[r]);void 0!==e.start&&this.toggleAnalyzer(e.start)}}e.AudioMotionAnalyzer=I,e.default=I});